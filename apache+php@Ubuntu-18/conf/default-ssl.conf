<IfModule mod_ssl.c>
        <VirtualHost _default_:${APACHE_SSL_PORT}>
                ServerAdmin ${APACHE_SERVER_ADMIN}
                ServerName ${APACHE_SERVER_NAME}
                ProxyRequests Off
                RemoteIPHeader X-Forwarded-For                
                Protocols ${APACHE_HTTP_PROTOCOLS}
                DocumentRoot /var/www/html
                LogLevel ${APACHE_LOG_LEVEL} ssl:${APACHE_SSL_LOG_LEVEL}
                ErrorLog ${APACHE_LOG_DIR}/${APACHE_SERVER_NAME}_error.log
                CustomLog ${APACHE_LOG_DIR}/${APACHE_SERVER_NAME}_access.log "%h %{SSL_PROTOCOL}x %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\""
                SSLEngine on
                SSLCertificateFile      /etc/ssl/certs/${APACHE_SSL_CERTS}
                SSLCertificateKeyFile /etc/ssl/private/${APACHE_SSL_PRIVATE}
                SSLCACertificatePath /etc/ssl/certs/

                <Directory "/var/www/html/secure">
                        SSLVerifyClient ${APACHE_SSL_VERIFY_CLIENT}
                        SSLVerifyDepth  5
                        SSLUserName SSL_CLIENT_S_DN_CN                   
                        <If "env('APACHE_SSL_VERIFY_CLIENT') =~ /optional|optional_no_ca/">
                                RewriteEngine on
                                RewriteCond %{SSL:SSL_CLIENT_VERIFY} !^SUCCESS$
                                RewriteRule .? - [F]
                                ErrorDocument 403 ${CLIENT_VERIFY_LANDING_PAGE}
                        </If>
                </Directory>

                <Location ${API_BASE_PATH}>
                        SSLOptions +ExportCertData +StdEnvVars

                        SSLVerifyClient require
                        SSLVerifyDepth  5

                        SSLUserName SSL_CLIENT_S_DN_CN
                        
                        RequestHeader set X-Forwarded-Proto expr=%{REQUEST_SCHEME}
                        RequestHeader set X-Forwarded-SSL expr=%{HTTPS}
                        RequestHeader set X-Client-DN %{SSL_CLIENT_S_DN}e
                        RequestHeader set X-Client-Verify %{SSL_CLIENT_VERIFY}e

                        ProxyPreserveHost On
                        ProxyPass ${HTTPBIN_BASE_URL}
                        ProxyPassReverse ${HTTPBIN_BASE_URL}
                </Location>

                <FilesMatch "\.(cgi|shtml|phtml|php)$">
                                SSLOptions +ExportCertData +StdEnvVars
                </FilesMatch>
                <Directory /usr/lib/cgi-bin>
                                SSLOptions +StdEnvVars
                </Directory>
        </VirtualHost>
</IfModule>